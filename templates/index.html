<!DOCTYPE html>
<html>
<head>
    <title>YNABU Reconcile</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        body { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
        input[type="text"], input[type="password"] { padding: 6px 10px; width: 220px; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #f7f7f7; padding: 10px; }
        .added { color: green; }
        .synced { color: #555; }
    </style>
</head>
<body>
    <h1>YNABU â€“ Reconcile</h1>

    <header>
        <input id="token"   name="token"      type="password" placeholder="YNAB Token"      title="Personal Access Token">
        <input id="budget"  name="budget_id"  type="text"     placeholder="Budget ID"       title="Budget ID">
        <input id="account" name="account_id" type="text"     placeholder="Account ID"      title="Account ID">
    </header>

    <form id="reconcile-form"
          hx-post="/api/reconcile"
          hx-encoding="multipart/form-data"
          hx-trigger="change from:input[type=file]"
          hx-target="#result"
          hx-include="#token,#budget,#account">
        <input type="file" name="statement" accept=".txt,.xls,.ofx" required>
    </form>

    <div id="result"></div>

    <script>
        // Persist credentials in localStorage
        function persist(id) {
            const el = document.getElementById(id);
            el.value = localStorage.getItem(id) || "";
            el.addEventListener('input', () => localStorage.setItem(id, el.value));
        }
        ['token','budget','account'].forEach(persist);



        // Handle response to show diff
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful && evt.detail.target.id === 'result') {
                try {
                    const response = JSON.parse(evt.detail.xhr.response);
                    if (response.status === 'success') {
                        const pre = document.createElement('pre');
                        pre.innerHTML = response.lines.map(l => {
                            if (l.startsWith('+')) {
                                return '<span class="added">' + l + '</span>';
                            }
                            return '<span class="synced">' + l + '</span>';
                        }).join('\n');

                        const summary = document.createElement('p');
                        summary.textContent = `Plan: ${response.to_add} transaction(s) will be added, ${response.in_sync} already in sync`;

                        evt.detail.target.innerHTML = '';
                        evt.detail.target.appendChild(pre);
                        evt.detail.target.appendChild(summary);
                        return;
                    }
                } catch (e) {
                    console.error(e);
                }
            }
            if (evt.detail.failed) {
                evt.detail.target.innerHTML = '<div class="error">' + evt.detail.xhr.responseText + '</div>';
            }
        });
    </script>
</body>
</html>
