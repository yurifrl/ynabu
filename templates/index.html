<!DOCTYPE html>
<html>
<head>
    <title>YNABU Reconcile</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        body { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
        header.config input[type="text"], header.config input[type="password"] { padding: 4px 8px; width: 260px; font-family: monospace; font-size: 13px; }
        .config-field { display: flex; flex-direction: column; font-size: 12px; }
        .config-field label { margin-bottom: 2px; color: #666; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #f7f7f7; padding: 10px; }
        .added { color: green; }
        .synced { color: #555; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f5f5f5; }
        .amount { text-align: right; }
        .amount.negative { color: red; }
        .amount.positive { color: green; }
        .actions { margin: 20px 0; display: flex; gap: 10px; }
        .copy-feedback { opacity: 0; transition: opacity 0.3s; margin-left: 10px; }
        .copy-feedback.show { opacity: 1; }
        #upload-label {
            display: block;
            width: 100%;
            max-width: 800px;
            margin: 40px auto;
            padding: 60px 20px;
            text-align: center;
            border: 2px dashed #aaa;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 24px;
        }
        #upload-label:hover { background: #eee; }
    </style>
</head>
<body>
    <h1>YNABU</h1>

    <header class="config">
        <div class="config-field">
            <label for="token">Token</label>
            <input id="token" name="token" type="password" placeholder="Personal Access Token" title="Personal Access Token">
        </div>
        <div class="config-field">
            <label for="account">Account</label>
            <select id="account" name="account_id">
                <option value="">Choose account</option>
                {{range .Accounts}}
                    <option value="{{.ID}}">{{.Name}}</option>
                {{end}}
            </select>
        </div>
        <div class="config-field">
            <label><input id="override" type="checkbox"> Override</label>
        </div>
        <div class="config-field" id="account-override-container" style="display:none">
            <label for="account-override">Account ID</label>
            <input id="account-override" name="account_id" type="text" placeholder="Account ID">
        </div>
    </header>


    <!-- Single file input -->
    <label for="statement" id="upload-label">Choose statement file</label>
    <input id="statement" type="file" name="statement" accept=".txt,.xls,.ofx,.csv" required style="display:none">

    <form id="reconcile-form"
          hx-post="/api/process"
          hx-encoding="multipart/form-data"
          hx-trigger="change from:#statement, change from:#account, change from:#account-override"
          hx-target="#result"
          hx-include="#token,#account,#account-override,#statement">
    </form>

    <div id="result"></div>

    <template id="csv-success-template">
        <div class="result-container">
            <div class="actions">
                <a href="" class="download-link">Download CSV</a>
                <button type="button" id="apply-btn">Apply</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Payee</th>
                        <th>Amount</th>
                        <th>Memo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </template>

    <script>
        // Persist credentials in localStorage
        function persist(id) {
            const el = document.getElementById(id);
            el.value = localStorage.getItem(id) || "";
            el.addEventListener('input', () => localStorage.setItem(id, el.value));
        }
        ['token', 'account-override'].forEach(persist);

        // Persist account select to localStorage
        const accountSelect = document.getElementById('account');
        accountSelect.value = localStorage.getItem('account') || "";
        accountSelect.addEventListener('change', () => {
            localStorage.setItem('account', accountSelect.value);
            if (fileInput.files && fileInput.files.length) {
                // Manually trigger the form request so the diff refreshes
                htmx.trigger(accountSelect, 'change');
            }
        });

        // Override account selection
        const overrideChk = document.getElementById('override');
        const accountOverrideContainer = document.getElementById('account-override-container');
        const accountOverrideInput = document.getElementById('account-override');

        // Restore persisted values
        overrideChk.checked = localStorage.getItem('override') === 'true';
        accountOverrideInput.value = localStorage.getItem('account-override') || '';

        function syncOverrideUI() {
            const isChecked = overrideChk.checked;
            accountSelect.style.display = isChecked ? 'none' : '';
            accountSelect.disabled = isChecked;
            accountOverrideContainer.style.display = isChecked ? 'flex' : 'none';
        }
        syncOverrideUI();

        overrideChk.addEventListener('change', () => {
            localStorage.setItem('override', overrideChk.checked);
            syncOverrideUI();
            htmx.trigger(accountOverrideInput, 'change');
        });

        accountOverrideInput.addEventListener('input', () => {
            localStorage.setItem('account-override', accountOverrideInput.value);
        });

        // Update file label on selection
        const fileInput = document.getElementById('statement');
        const fileLabel = document.getElementById('upload-label');
        fileInput.addEventListener('change', () => {
            if (fileInput.files && fileInput.files.length) {
                fileLabel.textContent = fileInput.files[0].name;
            } else {
                fileLabel.textContent = 'Choose statement file';
            }
        });



                // Handle response to show diff and CSV
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful && evt.detail.target.id === 'result') {
                // Clear previous results
                evt.detail.target.innerHTML = '';
                try {
                    const response = JSON.parse(evt.detail.xhr.response);
                    if (response.status === 'success') {
                        // Summary line
                        const summary = document.createElement('p');
                        summary.textContent = `Plan: ${response.to_add} transaction(s) will be added, ${response.in_sync} already in sync`;
                        evt.detail.target.appendChild(summary);

                        // Table template
                        const template = document.getElementById('csv-success-template');
                        const clone = template.content.cloneNode(true);
                        const link = clone.querySelector('.download-link');
                        link.href = '/api/files/' + response.file;
                        const tbody = clone.querySelector('tbody');

                        if (response.lines && response.lines.length) {
                            // Build diff table rows (+ added, = synced)
                            response.lines.forEach(l => {
                                const trimmed = l.trim();
                                const prefix = trimmed.charAt(0);
                                const content = trimmed.substring(2); // drop prefix and space
                                const parts = content.split('|').map(p => p.trim());
                                if (parts.length >= 3) {
                                    const row = document.createElement('tr');
                                    row.className = prefix === '+' ? 'added' : 'synced';
                                    row.innerHTML = `
                                        <td>${parts[0]}</td>
                                        <td>${parts[1]}</td>
                                        <td class="amount">${parts[2]}</td>
                                        <td></td>
                                    `;
                                    tbody.appendChild(row);
                                }
                            });
                        } else {
                            // Fallback: show CSV rows only
                            response.data.forEach(tx => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${tx.date}</td>
                                    <td>${tx.payee}</td>
                                    <td class="amount ${tx.amount < 0 ? 'negative' : ''}" data-raw-amount="${tx.amount}">${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(tx.amount)}</td>
                                    <td>${tx.memo}</td>
                                `;
                                tbody.appendChild(row);
                            });
                        }

                                                // wire apply button
                        const applyBtn = clone.querySelector('#apply-btn');
                        applyBtn.addEventListener('click', async () => {
                            const f = fileInput.files[0];
                            const acc = accountSelect.value;
                            if (!f || !acc) { alert('choose file and account'); return; }
                            const fd = new FormData();
                            fd.append('statement', f);
                            fd.append('account_id', acc);
                            const res = await fetch('/api/apply', { method: 'POST', body: fd });
                            const j = await res.json();
                            alert(j.status === 'applied' ? 'Applied ✔' : 'Apply failed');
                        });

                        evt.detail.target.appendChild(clone);
                        return;
                    }
                } catch (e) {
                    console.error(e);
                }
            }
            if (evt.detail.failed && evt.detail.target.id === 'result') {
                evt.detail.target.innerHTML = '<div class="error">' + evt.detail.xhr.responseText + '</div>';
            }
        });
    </script>
</body>
</html>
